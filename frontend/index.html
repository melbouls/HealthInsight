<!DOCTYPE html>
<html>
<head>
    <title>HealthInsight - Multi-Patient Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        h1 { text-align: center; color: #2c3e50; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .patient-name { font-size: 1.4em; font-weight: bold; margin-bottom: 10px; color: #3498db; border-bottom: 2px solid #ecf0f1; padding-bottom: 5px; }
        .status { font-weight: bold; }
        .critical { color: #e74c3c; }
        .stable { color: #27ae60; }
        .notes { font-size: 0.9em; color: #7f8c8d; font-style: italic; margin-top: 10px; }
        .chart-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; }
    </style>
</head>
<body>
    <h1>Tableau de Bord Hospitalier</h1>
    
    <div id="patient-grid" class="grid">
        </div>

    <div class="chart-container">
        <h2 style="text-align: center;">Moyennes Globales (Analyse Spark)</h2>
        <canvas id="statsChart"></canvas>
    </div>

    <script>
        const patientsToLoad = [
            { id: 'p1', name: 'Ali' },
            { id: 'p2', name: 'Melissa' },
            { id: 'p3', name: 'Mel' },
            { id: 'p4', name: 'Aya' }
        ];

        async function loadDashboard() {
            const grid = document.getElementById('patient-grid');
            
            // 1. Charger les infos de chaque patient
            for (const p of patientsToLoad) {
                try {
                    const response = await fetch(`http://localhost:3000/patients/${p.id}/readings`);
                    const readings = await response.json();
                    
                    const lastVal = readings.length > 0 ? readings[0].value : "N/A";
                    const isAbnormal = readings.length > 0 && readings[0].abnormal;
                    
                    // Création de la carte HTML
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="patient-name">${p.name}</div>
                        <div>Dernière mesure: <strong>${lastVal} ${readings[0]?.type === 'temperature' ? '°C' : 'BPM'}</strong></div>
                        <div class="status ${isAbnormal ? 'critical' : 'stable'}">
                            ${isAbnormal ? '⚠️ ALERTE' : '✅ STABLE'}
                        </div>
                        <div class="notes">Patient ID: ${p.id}</div>
                    `;
                    grid.appendChild(card);
                } catch (err) {
                    console.error(`Erreur pour ${p.name}:`, err);
                }
            }

            // 2. Charger le graphique Spark (Moyenne de l'hôpital)
            try {
                const resStats = await fetch('http://localhost:3000/stats');
                const dataStats = await resStats.json();
                
                const ctx = document.getElementById('statsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: dataStats.map(d => d.type),
                        datasets: [{
                            label: 'Moyenne Globale',
                            data: dataStats.map(d => d.moyenne),
                            backgroundColor: '#3498db'
                        }]
                    }
                });
            } catch (err) {
                console.error("Erreur stats:", err);
            }
        }

        loadDashboard();
    </script>
</body>
</html>